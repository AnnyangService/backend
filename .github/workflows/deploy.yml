name: Deploy to Production

on:
  push:
    branches: [ main ]  # main 브랜치에 push될 때 실행
  workflow_dispatch:    # 수동 실행 트리거 추가

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write   # OIDC에 필요한 권한
      contents: read    # 코드 체크아웃에 필요한 권한
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'corretto'

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ap-northeast-2
        
    - name: Get Parameters from SSM
      id: get-ssm-params
      run: |
        DB_URL=$(aws ssm get-parameter --name "/myapp/prod/db_url" --with-decryption --query "Parameter.Value" --output text)
        DB_USERNAME=$(aws ssm get-parameter --name "/myapp/prod/db_username" --with-decryption --query "Parameter.Value" --output text)
        DB_PASSWORD=$(aws ssm get-parameter --name "/myapp/prod/db_password" --with-decryption --query "Parameter.Value" --output text)
        SSH_USER=$(aws ssm get-parameter --name "/myapp/prod/ssh_user" --with-decryption --query "Parameter.Value" --output text)
        SSH_PRIVATE_KEY=$(aws ssm get-parameter --name "/myapp/prod/ssh_private_key" --with-decryption --query "Parameter.Value" --output text)
        
        # 민감한 정보는 GITHUB_OUTPUT에 저장하지 않고 환경 변수 파일에 저장
        echo "SSH_USER=$SSH_USER" >> $GITHUB_OUTPUT
        echo "DB_URL=$DB_URL" >> $GITHUB_ENV
        echo "DB_USERNAME=$DB_USERNAME" >> $GITHUB_ENV
        echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV
        # SSH 키는 여러 줄로 구성되어 있어 특별한 구문(<<EOF)을 사용해야 합니다.
        # 이 구문은, 시작(<<EOF), 내용, 끝(EOF)의 형식으로 여러 줄 텍스트를 환경 변수에 저장합니다.
        echo "SSH_PRIVATE_KEY<<EOF" >> $GITHUB_ENV
        echo "$SSH_PRIVATE_KEY" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Variable Substitution
      uses: microsoft/variable-substitution@v1
      with:
        files: 'src/main/resources/application-prod.yml'
      env:
        spring.datasource.url: ${{ env.DB_URL }}
        spring.datasource.username: ${{ env.DB_USERNAME }}
        spring.datasource.password: ${{ env.DB_PASSWORD }}
        jwt.secret: ${{ secrets.JWT_SECRET }}
        jwt.expiration: ${{ secrets.JWT_EXPIRATION }}

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0
        
    - name: Build with Gradle
      run: ./gradlew build  # 테스트 포함
        
    - name: Get GitHub Actions IP
      id: get-ip
      run: |
        echo "IP=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT
        
    - name: Add IP to Security Group
      run: |
        aws ec2 authorize-security-group-ingress \
          --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
          --protocol tcp \
          --port 22 \
          --cidr ${{ steps.get-ip.outputs.IP }}/32
          
    - name: Get EC2 Instance IP
      id: get-ec2-ip
      run: |
        INSTANCE_IP=$(aws ssm get-parameter \
          --name "/myapp/prod/instance-ip" \
          --with-decryption \
          --query "Parameter.Value" \
          --output text)
        echo "SSH_HOST=$INSTANCE_IP" >> $GITHUB_OUTPUT

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ env.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
          
    - name: Set JAR filename
      id: jar-filename
      run: |
        echo "JAR_FILE=$(ls build/libs/hi_meow-*.jar | xargs basename)" >> $GITHUB_OUTPUT
        
    - name: Deploy JAR and Update Symlink
      run: |
        scp -o StrictHostKeyChecking=no \
            -i ~/.ssh/deploy_key \
            build/libs/${{ steps.jar-filename.outputs.JAR_FILE }} \
            ${{ steps.get-ssm-params.outputs.SSH_USER }}@${{ steps.get-ec2-ip.outputs.SSH_HOST }}:/app/
        
        ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/deploy_key \
            ${{ steps.get-ssm-params.outputs.SSH_USER }}@${{ steps.get-ec2-ip.outputs.SSH_HOST }} \
            'cd /app && sudo systemctl stop myapp && ln -sfn ${{ steps.jar-filename.outputs.JAR_FILE }} myapp.jar && sudo systemctl start myapp'
             
    - name: Remove IP from Security Group
      if: always()  # 이전 단계가 실패하더라도 실행
      run: |
        aws ec2 revoke-security-group-ingress \
          --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
          --protocol tcp \
          --port 22 \
          --cidr ${{ steps.get-ip.outputs.IP }}/32 